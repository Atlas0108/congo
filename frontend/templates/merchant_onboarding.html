{% extends "base.html" %}

{% block title %}Become a Seller - Congo{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 py-8">
    <div class="bg-white rounded-lg shadow-lg p-8">
        <h1 class="text-3xl font-bold mb-2">Become a Seller on Congo</h1>
        <p class="text-gray-600 mb-8">Join thousands of local businesses selling on Congo. Complete the form below to get started.</p>
        
        <!-- Progress Steps -->
        <div class="mb-8">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center">
                    <div id="step-1-indicator" class="w-10 h-10 rounded-full bg-blue-600 text-white flex items-center justify-center font-semibold">1</div>
                    <span class="ml-2 font-medium">Business Info</span>
                </div>
                <div class="flex-1 h-1 mx-4 bg-gray-300">
                    <div id="step-1-progress" class="h-full bg-blue-600 transition-all duration-300" style="width: 0%"></div>
                </div>
                <div class="flex items-center">
                    <div id="step-2-indicator" class="w-10 h-10 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center font-semibold">2</div>
                    <span class="ml-2 font-medium text-gray-600">Documents</span>
                </div>
                <div class="flex-1 h-1 mx-4 bg-gray-300">
                    <div id="step-2-progress" class="h-full bg-blue-600 transition-all duration-300" style="width: 0%"></div>
                </div>
                <div class="flex items-center">
                    <div id="step-3-indicator" class="w-10 h-10 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center font-semibold">3</div>
                    <span class="ml-2 font-medium text-gray-600">Payment Info</span>
                </div>
                <div class="flex-1 h-1 mx-4 bg-gray-300">
                    <div id="step-3-progress" class="h-full bg-blue-600 transition-all duration-300" style="width: 0%"></div>
                </div>
                <div class="flex items-center">
                    <div id="step-4-indicator" class="w-10 h-10 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center font-semibold">4</div>
                    <span class="ml-2 font-medium text-gray-600">Review</span>
                </div>
            </div>
        </div>

        <form id="merchant-onboarding-form" enctype="multipart/form-data">
            <!-- Step 1: Business Information -->
            <div id="step-1" class="step-content">
                <h2 class="text-2xl font-semibold mb-6">Business Information</h2>
                
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Business Name *</label>
                        <input type="text" name="business_name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Your Business Name">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Business Type *</label>
                        <select name="business_type" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Select business type</option>
                            <option value="sole_proprietorship">Sole Proprietorship</option>
                            <option value="llc">LLC</option>
                            <option value="corporation">Corporation</option>
                            <option value="partnership">Partnership</option>
                            <option value="nonprofit">Nonprofit</option>
                            <option value="other">Other</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Business Description *</label>
                        <textarea name="description" required rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Describe your business and what you sell"></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Business Website</label>
                        <input type="url" name="website" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="https://yourwebsite.com">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Business Email *</label>
                        <input type="email" name="email" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="business@example.com">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Business Phone *</label>
                        <input type="tel" name="phone" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="(555) 123-4567">
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tax ID / EIN *</label>
                            <input type="text" name="tax_id" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="12-3456789">
                            <p class="text-xs text-gray-500 mt-1">For businesses: EIN. For individuals: SSN</p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Business Registration Number</label>
                            <input type="text" name="registration_number" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="State registration number">
                        </div>
                    </div>
                </div>

                <div class="mt-8 flex justify-end">
                    <button type="button" onclick="nextStep(2)" class="btn-primary btn-primary-lg">Next: Documents</button>
                </div>
            </div>

            <!-- Step 2: Business Address & Documents -->
            <div id="step-2" class="step-content hidden">
                <h2 class="text-2xl font-semibold mb-6">Business Address & Documents</h2>
                
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Business Address *</label>
                        <input type="text" name="address_line1" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mb-2" placeholder="Street Address">
                        <input type="text" name="address_line2" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Apt, Suite, etc. (optional)">
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">City *</label>
                            <input type="text" name="city" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">State *</label>
                            <input type="text" name="state" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ZIP Code *</label>
                            <input type="text" name="postal_code" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Country *</label>
                        <select name="country" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Select country</option>
                            <option value="US">United States</option>
                            <option value="CA">Canada</option>
                            <option value="MX">Mexico</option>
                        </select>
                    </div>

                    <div class="border-t border-gray-200 pt-6">
                        <h3 class="text-xl font-semibold mb-4">Required Documents</h3>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Business License *</label>
                                <input type="file" name="business_license" accept=".pdf,.jpg,.jpeg,.png" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <p class="text-xs text-gray-500 mt-1">Upload a copy of your business license (PDF, JPG, or PNG)</p>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tax Document (W-9 or equivalent) *</label>
                                <input type="file" name="tax_document" accept=".pdf,.jpg,.jpeg,.png" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <p class="text-xs text-gray-500 mt-1">Upload your completed W-9 form or equivalent tax document</p>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Government-Issued ID *</label>
                                <input type="file" name="government_id" accept=".pdf,.jpg,.jpeg,.png" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <p class="text-xs text-gray-500 mt-1">Driver's license, passport, or other government-issued ID</p>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Business Logo</label>
                                <input type="file" name="logo" accept=".jpg,.jpeg,.png,.svg" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <p class="text-xs text-gray-500 mt-1">Upload your business logo (optional, can be added later)</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-8 flex justify-between">
                    <button type="button" onclick="previousStep(1)" class="btn-secondary btn-secondary-lg">Previous</button>
                    <button type="button" onclick="nextStep(3)" class="btn-primary btn-primary-lg">Next: Payment Info</button>
                </div>
            </div>

            <!-- Step 3: Payment Information -->
            <div id="step-3" class="step-content hidden">
                <h2 class="text-2xl font-semibold mb-6">Payment Information</h2>
                <p class="text-gray-600 mb-6">We need your banking information to process payments. All information is encrypted and secure.</p>
                
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Account Holder Name *</label>
                        <input type="text" name="account_holder_name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Name on bank account">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Bank Name *</label>
                        <input type="text" name="bank_name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Your bank name">
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Account Type *</label>
                            <select name="account_type" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Select account type</option>
                                <option value="checking">Checking</option>
                                <option value="savings">Savings</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Routing Number *</label>
                            <input type="text" name="routing_number" required pattern="[0-9]{9}" maxlength="9" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="123456789">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Account Number *</label>
                        <input type="text" name="account_number" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Your account number">
                        <p class="text-xs text-gray-500 mt-1">This information is encrypted and stored securely</p>
                    </div>

                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <div class="flex items-start">
                            <svg class="w-5 h-5 text-blue-600 mt-0.5 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                            </svg>
                            <div class="text-sm text-blue-800">
                                <p class="font-medium mb-1">Secure Payment Processing</p>
                                <p>Your banking information is encrypted using industry-standard security measures. We never store your full account number in plain text.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-8 flex justify-between">
                    <button type="button" onclick="previousStep(2)" class="btn-secondary btn-secondary-lg">Previous</button>
                    <button type="button" onclick="nextStep(4)" class="btn-primary btn-primary-lg">Next: Review</button>
                </div>
            </div>

            <!-- Step 4: Review & Submit -->
            <div id="step-4" class="step-content hidden">
                <h2 class="text-2xl font-semibold mb-6">Review & Submit</h2>
                <p class="text-gray-600 mb-6">Please review your information before submitting. You'll be able to edit this information later.</p>
                
                <div id="review-summary" class="space-y-6">
                    <!-- Review content will be populated by JavaScript -->
                </div>

                <div class="mt-8 border-t border-gray-200 pt-6">
                    <div class="flex items-start mb-4">
                        <input type="checkbox" id="terms_agreement" name="terms_agreement" required class="mt-1 mr-3">
                        <label for="terms_agreement" class="text-sm text-gray-700">
                            I agree to the <a href="#" class="text-blue-600 hover:underline">Congo Seller Agreement</a> and <a href="#" class="text-blue-600 hover:underline">Terms of Service</a>. *
                        </label>
                    </div>

                    <div class="flex items-start mb-4">
                        <input type="checkbox" id="privacy_agreement" name="privacy_agreement" required class="mt-1 mr-3">
                        <label for="privacy_agreement" class="text-sm text-gray-700">
                            I have read and agree to the <a href="#" class="text-blue-600 hover:underline">Privacy Policy</a>. *
                        </label>
                    </div>

                    <div class="flex items-start">
                        <input type="checkbox" id="tax_agreement" name="tax_agreement" required class="mt-1 mr-3">
                        <label for="tax_agreement" class="text-sm text-gray-700">
                            I understand that I am responsible for collecting and remitting applicable sales tax. *
                        </label>
                    </div>
                </div>

                <div class="mt-8 flex justify-between">
                    <button type="button" onclick="previousStep(3)" class="btn-secondary btn-secondary-lg">Previous</button>
                    <button type="submit" class="btn-primary btn-primary-lg">Submit Application</button>
                </div>
            </div>
        </form>

        <!-- Success Message -->
        <div id="success-message" class="hidden mt-8 bg-green-50 border border-green-200 rounded-lg p-6">
            <div class="flex items-center">
                <svg class="w-6 h-6 text-green-600 mr-3" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                </svg>
                <div>
                    <h3 class="text-lg font-semibold text-green-800">Application Submitted Successfully!</h3>
                    <p class="text-green-700 mt-1">We've received your merchant application. Our team will review it and get back to you within 2-3 business days.</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentStep = 1;
    const totalSteps = 4;

    function updateProgress() {
        // Update step indicators
        for (let i = 1; i <= totalSteps; i++) {
            const indicator = document.getElementById(`step-${i}-indicator`);
            if (i < currentStep) {
                indicator.classList.remove('bg-gray-300', 'text-gray-600');
                indicator.classList.add('bg-green-600', 'text-white');
                indicator.innerHTML = '<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>';
            } else if (i === currentStep) {
                indicator.classList.remove('bg-gray-300', 'text-gray-600', 'bg-green-600');
                indicator.classList.add('bg-blue-600', 'text-white');
                indicator.textContent = i;
            } else {
                indicator.classList.remove('bg-blue-600', 'text-white', 'bg-green-600');
                indicator.classList.add('bg-gray-300', 'text-gray-600');
                indicator.textContent = i;
            }
        }

        // Update progress bars
        for (let i = 1; i < currentStep; i++) {
            const progress = document.getElementById(`step-${i}-progress`);
            if (progress) progress.style.width = '100%';
        }
        if (currentStep > 1) {
            const prevProgress = document.getElementById(`step-${currentStep - 1}-progress`);
            if (prevProgress) prevProgress.style.width = '100%';
        }
    }

    function showStep(step) {
        // Hide all steps
        for (let i = 1; i <= totalSteps; i++) {
            document.getElementById(`step-${i}`).classList.add('hidden');
        }
        // Show current step
        document.getElementById(`step-${step}`).classList.remove('hidden');
        currentStep = step;
        updateProgress();

        // If on review step, populate review summary
        if (step === 4) {
            populateReviewSummary();
        }
    }

    function nextStep(step) {
        // Validate current step before proceeding
        const currentStepElement = document.getElementById(`step-${currentStep}`);
        const form = currentStepElement.closest('form');
        const inputs = currentStepElement.querySelectorAll('input[required], select[required], textarea[required]');
        
        let isValid = true;
        inputs.forEach(input => {
            if (!input.value.trim()) {
                isValid = false;
                input.classList.add('border-red-500');
            } else {
                input.classList.remove('border-red-500');
            }
        });

        // Check file inputs
        const fileInputs = currentStepElement.querySelectorAll('input[type="file"][required]');
        fileInputs.forEach(input => {
            if (!input.files || input.files.length === 0) {
                isValid = false;
                input.classList.add('border-red-500');
            } else {
                input.classList.remove('border-red-500');
            }
        });

        if (!isValid) {
            alert('Please fill in all required fields before proceeding.');
            return;
        }

        showStep(step);
    }

    function previousStep(step) {
        showStep(step);
    }

    function populateReviewSummary() {
        const form = document.getElementById('merchant-onboarding-form');
        const formData = new FormData(form);
        const summary = document.getElementById('review-summary');

        const sections = [
            {
                title: 'Business Information',
                fields: [
                    { label: 'Business Name', name: 'business_name' },
                    { label: 'Business Type', name: 'business_type' },
                    { label: 'Description', name: 'description' },
                    { label: 'Website', name: 'website' },
                    { label: 'Email', name: 'email' },
                    { label: 'Phone', name: 'phone' },
                    { label: 'Tax ID', name: 'tax_id' },
                    { label: 'Registration Number', name: 'registration_number' }
                ]
            },
            {
                title: 'Business Address',
                fields: [
                    { label: 'Address', name: 'address_line1', name2: 'address_line2' },
                    { label: 'City', name: 'city' },
                    { label: 'State', name: 'state' },
                    { label: 'ZIP Code', name: 'postal_code' },
                    { label: 'Country', name: 'country' }
                ]
            },
            {
                title: 'Payment Information',
                fields: [
                    { label: 'Account Holder', name: 'account_holder_name' },
                    { label: 'Bank Name', name: 'bank_name' },
                    { label: 'Account Type', name: 'account_type' },
                    { label: 'Routing Number', name: 'routing_number' },
                    { label: 'Account Number', name: 'account_number', mask: true }
                ]
            },
            {
                title: 'Documents',
                fields: [
                    { label: 'Business License', name: 'business_license', type: 'file' },
                    { label: 'Tax Document', name: 'tax_document', type: 'file' },
                    { label: 'Government ID', name: 'government_id', type: 'file' },
                    { label: 'Logo', name: 'logo', type: 'file' }
                ]
            }
        ];

        let html = '';
        sections.forEach(section => {
            html += `<div class="bg-gray-50 rounded-lg p-4">
                <h3 class="font-semibold text-lg mb-3">${section.title}</h3>
                <div class="space-y-2">`;
            
            section.fields.forEach(field => {
                let value = '';
                if (field.type === 'file') {
                    const fileInput = form.querySelector(`[name="${field.name}"]`);
                    if (fileInput && fileInput.files && fileInput.files.length > 0) {
                        value = fileInput.files[0].name;
                    } else {
                        value = 'Not uploaded';
                    }
                } else if (field.name2) {
                    const val1 = formData.get(field.name) || '';
                    const val2 = formData.get(field.name2) || '';
                    value = val1 + (val2 ? ', ' + val2 : '');
                } else {
                    value = formData.get(field.name) || 'Not provided';
                }

                if (field.mask && value !== 'Not provided') {
                    value = '••••' + value.slice(-4);
                }

                html += `<div class="flex justify-between py-2 border-b border-gray-200">
                    <span class="text-gray-600">${field.label}:</span>
                    <span class="font-medium">${value}</span>
                </div>`;
            });

            html += `</div></div>`;
        });

        summary.innerHTML = html;
    }

    // Form submission
    document.getElementById('merchant-onboarding-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        const submitButton = e.target.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        submitButton.textContent = 'Submitting...';

        const formData = new FormData(e.target);

        try {
            const response = await fetch('/api/users/merchants/onboard', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (response.ok) {
                // Show success message
                document.getElementById('merchant-onboarding-form').classList.add('hidden');
                document.getElementById('success-message').classList.remove('hidden');
                
                // Scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } else {
                alert('Error submitting application: ' + (data.error || 'Please try again later.'));
                submitButton.disabled = false;
                submitButton.textContent = 'Submit Application';
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error submitting application. Please try again later.');
            submitButton.disabled = false;
            submitButton.textContent = 'Submit Application';
        }
    });

    // Initialize
    updateProgress();
</script>
{% endblock %}

