{% extends "base.html" %}

{% block title %}Products - Congo{% endblock %}

{% block content %}
<script>
    // Set data attribute immediately to hide title via CSS (runs before any rendering)
    if (window.location.search.includes('local=true')) {
        document.documentElement.setAttribute('data-local-products', 'true');
    }
</script>
<style>
    /* Override main container for local products page to remove spacing */
    #local-products-page main {
        max-width: 100% !important;
        padding: 0 !important;
        margin: 0 !important;
    }
    
    /* Simple background image with fade-in for local products page */
    #local-products-page #products-page-wrapper {
        position: relative;
        min-height: 100vh;
    }
    
    /* Background image using pseudo-element so we can fade it independently */
    #local-products-page #products-page-wrapper::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-image: url("{{ url_for('static', filename='images/walnut-creek.webp') }}");
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        background-attachment: scroll;
        opacity: 0;
        z-index: 0;
        animation: fadeInBackground 1s ease-in-out forwards;
        pointer-events: none;
    }
    
    /* Gradient overlay using pseudo-element - fades to F4F3ED */
    #local-products-page #products-page-wrapper::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(to bottom, rgba(244, 243, 237, 0) 0%, rgba(244, 243, 237, 0.3) 30%, rgba(244, 243, 237, 0.7) 60%, rgba(244, 243, 237, 0.95) 85%, rgba(244, 243, 237, 1) 100%);
        pointer-events: none;
        z-index: 1;
    }
    
    /* Ensure content is above the background and gradient */
    #local-products-page #products-page-wrapper > * {
        position: relative;
        z-index: 2;
    }
    
    @keyframes fadeInBackground {
        from {
            opacity: 0;
        }
        to {
            opacity: 0.3;
        }
    }
    
    /* After animation completes, keep opacity stable */
    #local-products-page #products-page-wrapper.background-loaded::before {
        animation: none;
        opacity: 0.3;
    }
    
    /* Hide title immediately if local param is in URL (via data attribute) */
    html[data-local-products="true"] h1#page-title {
        opacity: 0 !important;
        transition: opacity 0.3s ease-in-out;
    }
    
    /* Show title when city is loaded */
    html[data-local-products="true"] h1#page-title.city-loaded {
        opacity: 1 !important;
    }
    
    /* Shimmer loading effect */
    @keyframes shimmer {
        0% {
            background-position: -1000px 0;
        }
        100% {
            background-position: 1000px 0;
        }
    }
    
    .shimmer {
        animation: shimmer 2s infinite;
        background: linear-gradient(to right, #f0f0f0 0%, #e0e0e0 20%, #f0f0f0 40%, #f0f0f0 100%);
        background-size: 1000px 100%;
    }
    
    .shimmer-card {
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }
    
    .shimmer-image {
        width: 100%;
        height: 12rem;
        background: #e0e0e0;
    }
    
    .shimmer-text {
        height: 1rem;
        border-radius: 0.25rem;
        margin-bottom: 0.5rem;
    }
    
    .shimmer-text.short {
        width: 60%;
    }
    
    .shimmer-text.medium {
        width: 80%;
    }
    
    .shimmer-text.long {
        width: 100%;
    }
    
    .shimmer-button {
        width: 100%;
        height: 2.5rem;
        border-radius: 0.5rem;
        background: #e0e0e0;
    }
    
    /* Fade transitions - only affect products container, not background */
    #products-container {
        transition: opacity 0.3s ease-in-out;
        position: relative;
        z-index: 2;
        /* Prevent affecting parent wrapper */
        isolation: isolate;
    }
    
    #products-container.fade-out {
        opacity: 0;
    }
    
    #products-container.fade-in {
        opacity: 1;
    }
    
    /* Ensure wrapper pseudo-elements are isolated from container changes */
    #local-products-page #products-page-wrapper {
        isolation: isolate;
        contain: layout style;
    }
    
    .product-card {
        animation: fadeIn 0.4s ease-in-out;
    }
    
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
</style>
<div id="products-page-wrapper" class="min-h-screen">
    <div class="mb-6">
        <h1 id="page-title" class="text-3xl font-bold mb-4">Products</h1>
    
    <!-- Filter -->
        <div id="category-filter-container" class="flex flex-col md:flex-row gap-4 mb-6">
        <select id="category-filter" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none">
            <option value="">All Categories</option>
        </select>
    </div>
</div>

<!-- Products Grid -->
<div id="products-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <!-- Products will be loaded here -->
</div>

<!-- Pagination -->
<div id="pagination" class="flex justify-center space-x-2">
    <!-- Pagination will be loaded here -->
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentPage = 1;
    let currentCategory = '';
    let currentSearch = '';
    let currentLocal = false;

    function showShimmerLoader() {
        const container = document.getElementById('products-container');
        container.classList.add('fade-out');
        
        setTimeout(() => {
            const shimmerHTML = Array.from({length: 12}, () => `
                <div class="shimmer-card">
                    <div class="shimmer shimmer-image"></div>
                    <div class="p-4">
                        <div class="shimmer shimmer-text short mb-3"></div>
                        <div class="shimmer shimmer-text medium mb-2"></div>
                        <div class="shimmer shimmer-text short mb-4"></div>
                        <div class="shimmer shimmer-text long mb-2"></div>
                        <div class="shimmer shimmer-text long mb-4"></div>
                        <div class="shimmer shimmer-button"></div>
                    </div>
                </div>
            `).join('');
            container.innerHTML = shimmerHTML;
            container.classList.remove('fade-out');
            container.classList.add('fade-in');
        }, 150);
    }

    function loadProducts(page = 1, category = '', search = '', local = false) {
        const startTime = Date.now();
        const minDisplayTime = 1000; // 1 second minimum
        
        // Show shimmer loader
        showShimmerLoader();
        
        let url = `/api/products/?page=${page}&per_page=12`;
        if (category) url += `&category=${encodeURIComponent(category)}`;
        if (search) url += `&search=${encodeURIComponent(search)}`;
        if (local) url += `&local=true`;

        fetch(url)
            .then(response => {
                if (!response.ok) {
                    console.error('API Error:', response.status, response.statusText);
                    return response.json().then(err => {
                        console.error('Error details:', err);
                        throw new Error(err.error || 'Failed to load products');
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('Products loaded:', data.products?.length || 0, 'products');
                // Calculate elapsed time and ensure minimum display time
                const elapsedTime = Date.now() - startTime;
                const remainingTime = Math.max(0, minDisplayTime - elapsedTime);
                
                setTimeout(() => {
                const container = document.getElementById('products-container');
                    // Only fade out the container, not the wrapper
                    container.classList.add('fade-out');
                    
                    setTimeout(() => {
                if (data.products.length === 0) {
                    container.innerHTML = '<p class="col-span-full text-center text-gray-500 py-8">No products found.</p>';
                } else {
                    container.innerHTML = data.products.map(product => `
                        <div class="product-card bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition">
                            <a href="/product/${product.id}">
                                <img src="${product.image_url || '/static/images/placeholder.svg'}" alt="${product.name}" class="w-full h-48 object-cover bg-gray-200" onerror="this.onerror=null; this.src='/static/images/placeholder.svg';">
                            </a>
                            <div class="p-4">
                                <a href="/product/${product.id}">
                                    <h3 class="font-semibold text-base mb-1.5 hover:opacity-80 line-clamp-2" style="color: #004FFF;">${product.name}</h3>
                                </a>
                                
                                <!-- Rating -->
                                ${product.rating > 0 ? `
                                    <div class="mb-1 flex items-center gap-0.5">
                                        <span class="text-blue-600 text-sm font-medium">${product.rating.toFixed(1)}</span>
                                        <div class="flex items-center">
                                            ${Array.from({length: 5}, (_, i) => {
                                                const rating = product.rating;
                                                if (i < Math.floor(rating)) {
                                                    return `<span class="text-orange-400 text-xs">★</span>`;
                                                } else if (i === Math.floor(rating) && rating % 1 >= 0.5) {
                                                    return `<span class="text-orange-400 text-xs">★</span>`;
                                                } else {
                                                    return `<span class="text-gray-300 text-xs">★</span>`;
                                                }
                                            }).join('')}
                                        </div>
                                        <a href="/product/${product.id}" class="text-blue-600 hover:underline text-xs ml-0.5">
                                            (${product.review_count >= 1000 ? (product.review_count / 1000).toFixed(1) + 'K' : product.review_count})
                                        </a>
                                    </div>
                                ` : ''}
                                
                                <!-- Price -->
                                <div class="mb-1">
                                    <span class="text-xl font-bold text-gray-900">
                                        $${product.price.toFixed(2).split('.')[0]}<sup class="text-sm font-normal">${product.price.toFixed(2).split('.')[1]}</sup>
                                    </span>
                                </div>
                                
                                <!-- Delivery Info -->
                                ${product.shipping_time ? `
                                    <div class="mb-1.5 flex items-center gap-1 text-xs">
                                        ${product.id % 2 === 0 ? '<svg style="color: #ED6A5A;" class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/></svg>' : ''}
                                        <span style="color: #0EAD69;">${product.id % 2 === 0 ? 'local' : 'USA'}</span>
                                        <span class="text-gray-700">${product.shipping_time}</span>
                                    </div>
                                    <div class="mb-2 text-xs text-gray-700">
                                        FREE delivery ${product.shipping_time}
                                    </div>
                                ` : ''}
                                
                                <p class="text-gray-600 text-xs mb-3 line-clamp-2">${product.description || ''}</p>
                                
                                <div class="flex items-center justify-between">
                                    <button onclick="addToCart(${product.id})" data-product-id="${product.id}" class="btn-primary btn-primary-md">
                                        Add to Cart
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }

                // Pagination
                const pagination = document.getElementById('pagination');
                if (data.pages > 1) {
                    let paginationHTML = '';
                    if (data.page > 1) {
                        paginationHTML += `<button onclick="loadProducts(${data.page - 1}, '${category}', '${search}', ${local})" class="px-4 py-2 border rounded hover:bg-gray-100">Previous</button>`;
                    }
                    for (let i = 1; i <= data.pages; i++) {
                        if (i === data.page) {
                            paginationHTML += `<button class="btn-primary btn-primary-md font-semibold">${i}</button>`;
                        } else {
                            paginationHTML += `<button onclick="loadProducts(${i}, '${category}', '${search}', ${local})" class="px-4 py-2 border rounded hover:bg-gray-100">${i}</button>`;
                        }
                    }
                    if (data.page < data.pages) {
                        paginationHTML += `<button onclick="loadProducts(${data.page + 1}, '${category}', '${search}', ${local})" class="px-4 py-2 border rounded hover:bg-gray-100">Next</button>`;
                    }
                    pagination.innerHTML = paginationHTML;
                } else {
                    pagination.innerHTML = '';
                }
                    
                    // Fade in the new content
                    container.classList.remove('fade-out');
                    container.classList.add('fade-in');
                }, 150);
                }, remainingTime);
            })
            .catch(error => {
                console.error('Error loading products:', error);
                console.error('Error details:', {
                    message: error.message,
                    stack: error.stack,
                    url: url
                });
                const elapsedTime = Date.now() - startTime;
                const remainingTime = Math.max(0, minDisplayTime - elapsedTime);
                
                setTimeout(() => {
                const container = document.getElementById('products-container');
                if (container) {
                        container.classList.add('fade-out');
                        setTimeout(() => {
                    container.innerHTML = `<p class="col-span-full text-center text-red-500 py-8">Error loading products: ${error.message}. Check console for details.</p>`;
                            container.classList.remove('fade-out');
                            container.classList.add('fade-in');
                        }, 150);
                }
                }, remainingTime);
            });
    }

    // Load categories
    fetch('/api/products/categories')
        .then(response => response.json())
        .then(categories => {
            const select = document.getElementById('category-filter');
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                select.appendChild(option);
            });
        });

    // Get parameters from URL
    const urlParams = new URLSearchParams(window.location.search);
    const searchParam = urlParams.get('search');
    const localParam = urlParams.get('local');
    const categoryParam = urlParams.get('category');
    
    if (searchParam) {
        currentSearch = searchParam;
    }
    if (localParam === 'true') {
        currentLocal = true;
        
        // Add ID to body to target with CSS
        document.body.id = 'local-products-page';
        // Ensure data attribute is set for CSS targeting
        document.documentElement.setAttribute('data-local-products', 'true');
        
        // Apply background image with fade effect (only once on initial load)
        if (!window.backgroundInitialized) {
            const wrapper = document.getElementById('products-page-wrapper');
            if (wrapper) {
                // Background image is handled by CSS on the wrapper
                wrapper.style.width = '100%';
                wrapper.style.margin = '0';
                wrapper.style.padding = '0';
                
                // Add padding to content elements for readability
                const titleDiv = wrapper.querySelector('.mb-6');
                if (titleDiv) {
                    titleDiv.style.padding = '2rem 2rem 1rem';
                }
                const productsContainer = document.getElementById('products-container');
                if (productsContainer) {
                    productsContainer.style.padding = '0 2rem';
                }
                const pagination = document.getElementById('pagination');
                if (pagination) {
                    pagination.style.padding = '2rem';
                }
                
                // Mark background as loaded after animation completes to prevent retriggering
                setTimeout(() => {
                    wrapper.classList.add('background-loaded');
                }, 1000);
                
                window.backgroundInitialized = true;
            }
        }
        
        // Get city from delivery location or saved addresses
        function updateLocalProductsTitle() {
            const cityZip = document.getElementById('delivery-city-zip');
            let city = null;
            
            if (cityZip && cityZip.textContent) {
                // Extract city from "City ZIP" format
                const cityZipText = cityZip.textContent.trim();
                const cityMatch = cityZipText.match(/^([^0-9]+)/);
                if (cityMatch) {
                    city = cityMatch[1].trim();
                }
            } else if (window.savedAddresses && window.savedAddresses.length > 0) {
                // Try to get city from saved addresses
                const selectedAddress = window.savedAddresses.find(addr => addr.id === window.selectedAddressId) ||
                                      window.savedAddresses.find(addr => addr.is_default) ||
                                      window.savedAddresses[0];
                if (selectedAddress && selectedAddress.city) {
                    city = selectedAddress.city;
                }
            }
            
            // Update title if we have a real city
            const titleElement = document.getElementById('page-title');
            if (titleElement && city && city.trim() && city !== 'Your City') {
                titleElement.textContent = `Shop ${city}`;
                titleElement.classList.add('city-loaded');
            }
        }
        
        // Update title immediately if city is available, otherwise wait for addresses to load
        updateLocalProductsTitle();
        
        // Also try to update after a short delay in case addresses are still loading
        setTimeout(updateLocalProductsTitle, 500);
        
        // Also update when addresses are loaded
        const checkInterval = setInterval(() => {
            if (window.savedAddresses && window.savedAddresses.length > 0) {
                updateLocalProductsTitle();
                clearInterval(checkInterval);
            }
        }, 200);
        
        // Hide category filter dropdown on local products page
        const categoryFilterContainer = document.getElementById('category-filter-container');
        if (categoryFilterContainer) {
            categoryFilterContainer.style.display = 'none';
        }
        // Clear category filter to show all local products
        currentCategory = '';
    } else {
        // Load category from URL parameter or sessionStorage (only when not on local page)
        if (categoryParam) {
            currentCategory = categoryParam;
            sessionStorage.setItem('selectedCategory', categoryParam);
            sessionStorage.setItem('selectedCategoryDisplay', categoryParam);
        } else {
            // Load from sessionStorage if no URL parameter
            const savedCategory = sessionStorage.getItem('selectedCategory');
            if (savedCategory) {
                currentCategory = savedCategory;
            }
        }
        
        // Set the category filter dropdown value
        const categoryFilter = document.getElementById('category-filter');
        if (categoryFilter && currentCategory) {
            categoryFilter.value = currentCategory;
        }
    }

    // Event listeners
    document.getElementById('category-filter').addEventListener('change', (e) => {
        currentCategory = e.target.value;
        currentPage = 1;
        // Save to sessionStorage
        sessionStorage.setItem('selectedCategory', currentCategory);
        sessionStorage.setItem('selectedCategoryDisplay', currentCategory);
        loadProducts(currentPage, currentCategory, currentSearch, currentLocal);
    });

    // Sync header search input with current search
    const headerSearchInput = document.getElementById('header-search-input');
    const mobileSearchInput = document.getElementById('mobile-search-input');
    
    function syncSearchInputs() {
        if (headerSearchInput) {
            headerSearchInput.addEventListener('input', (e) => {
                currentSearch = e.target.value;
                currentPage = 1;
                loadProducts(currentPage, currentCategory, currentSearch, currentLocal);
                // Sync with mobile input
                if (mobileSearchInput) {
                    mobileSearchInput.value = e.target.value;
                }
            });
            
            // Set initial value if coming from URL
            if (searchParam) {
                headerSearchInput.value = searchParam;
            }
        }
        
        if (mobileSearchInput) {
            mobileSearchInput.addEventListener('input', (e) => {
                currentSearch = e.target.value;
                currentPage = 1;
                loadProducts(currentPage, currentCategory, currentSearch, currentLocal);
                // Sync with header input
                if (headerSearchInput) {
                    headerSearchInput.value = e.target.value;
                }
            });
            
            // Set initial value if coming from URL
            if (searchParam) {
                mobileSearchInput.value = searchParam;
            }
        }
    }
    
    syncSearchInputs();

    // Load products on page load (shimmer will be shown by loadProducts)
    loadProducts(currentPage, currentCategory, currentSearch, currentLocal);
</script>
{% endblock %}

