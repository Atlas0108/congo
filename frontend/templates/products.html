{% extends "base.html" %}

{% block title %}Products - Congo{% endblock %}

{% block content %}
<div class="mb-6">
    <h1 class="text-3xl font-bold mb-4">Products</h1>
    
    <!-- Filter -->
    <div class="flex flex-col md:flex-row gap-4 mb-6">
        <select id="category-filter" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none">
            <option value="">All Categories</option>
        </select>
    </div>
</div>

<!-- Products Grid -->
<div id="products-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <!-- Products will be loaded here -->
</div>

<!-- Pagination -->
<div id="pagination" class="flex justify-center space-x-2">
    <!-- Pagination will be loaded here -->
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentPage = 1;
    let currentCategory = '';
    let currentSearch = '';

    function loadProducts(page = 1, category = '', search = '') {
        let url = `/api/products/?page=${page}&per_page=12`;
        if (category) url += `&category=${encodeURIComponent(category)}`;
        if (search) url += `&search=${encodeURIComponent(search)}`;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('products-container');
                if (data.products.length === 0) {
                    container.innerHTML = '<p class="col-span-full text-center text-gray-500 py-8">No products found.</p>';
                } else {
                    container.innerHTML = data.products.map(product => `
                        <div class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition">
                            <a href="/product/${product.id}">
                                <img src="${product.image_url || '/static/images/placeholder.svg'}" alt="${product.name}" class="w-full h-48 object-cover bg-gray-200" onerror="this.onerror=null; this.src='/static/images/placeholder.svg';">
                            </a>
                            <div class="p-4">
                                <a href="/product/${product.id}">
                                    <h3 class="font-semibold text-lg mb-2 hover:opacity-80" style="color: #004FFF;">${product.name}</h3>
                                </a>
                                <p class="text-gray-600 text-sm mb-2 line-clamp-2">${product.description || ''}</p>
                                <div class="flex items-center justify-between">
                                    <span class="text-2xl font-bold text-gray-900">$${product.price.toFixed(2)}</span>
                                    <button onclick="addToCart(${product.id})" style="background-color: #004FFF;" class="text-white px-4 py-2 rounded hover:opacity-90">
                                        Add to Cart
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }

                // Pagination
                const pagination = document.getElementById('pagination');
                if (data.pages > 1) {
                    let paginationHTML = '';
                    if (data.page > 1) {
                        paginationHTML += `<button onclick="loadProducts(${data.page - 1}, '${category}', '${search}')" class="px-4 py-2 border rounded hover:bg-gray-100">Previous</button>`;
                    }
                    for (let i = 1; i <= data.pages; i++) {
                        if (i === data.page) {
                            paginationHTML += `<button style="background-color: #004FFF;" class="px-4 py-2 text-white rounded font-semibold">${i}</button>`;
                        } else {
                            paginationHTML += `<button onclick="loadProducts(${i}, '${category}', '${search}')" class="px-4 py-2 border rounded hover:bg-gray-100">${i}</button>`;
                        }
                    }
                    if (data.page < data.pages) {
                        paginationHTML += `<button onclick="loadProducts(${data.page + 1}, '${category}', '${search}')" class="px-4 py-2 border rounded hover:bg-gray-100">Next</button>`;
                    }
                    pagination.innerHTML = paginationHTML;
                } else {
                    pagination.innerHTML = '';
                }
            });
    }

    // Load categories
    fetch('/api/products/categories')
        .then(response => response.json())
        .then(categories => {
            const select = document.getElementById('category-filter');
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                select.appendChild(option);
            });
        });

    // Get search term from URL
    const urlParams = new URLSearchParams(window.location.search);
    const searchParam = urlParams.get('search');
    if (searchParam) {
        currentSearch = searchParam;
    }

    // Event listeners
    document.getElementById('category-filter').addEventListener('change', (e) => {
        currentCategory = e.target.value;
        currentPage = 1;
        loadProducts(currentPage, currentCategory, currentSearch);
    });

    // Sync header search input with current search
    const headerSearchInput = document.getElementById('header-search-input');
    const mobileSearchInput = document.getElementById('mobile-search-input');
    
    function syncSearchInputs() {
        if (headerSearchInput) {
            headerSearchInput.addEventListener('input', (e) => {
                currentSearch = e.target.value;
                currentPage = 1;
                loadProducts(currentPage, currentCategory, currentSearch);
                // Sync with mobile input
                if (mobileSearchInput) {
                    mobileSearchInput.value = e.target.value;
                }
            });
            
            // Set initial value if coming from URL
            if (searchParam) {
                headerSearchInput.value = searchParam;
            }
        }
        
        if (mobileSearchInput) {
            mobileSearchInput.addEventListener('input', (e) => {
                currentSearch = e.target.value;
                currentPage = 1;
                loadProducts(currentPage, currentCategory, currentSearch);
                // Sync with header input
                if (headerSearchInput) {
                    headerSearchInput.value = e.target.value;
                }
            });
            
            // Set initial value if coming from URL
            if (searchParam) {
                mobileSearchInput.value = searchParam;
            }
        }
    }
    
    syncSearchInputs();

    // Load products on page load
    loadProducts();
</script>
{% endblock %}

